<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG-Demo - Ambiente Educacional</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <!-- Marked.js para renderiza√ß√£o de Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js para syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* Anima√ß√µes e estilos customizados */
        .chat-message {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-dots {
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0%, 20% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .markdown-content {
            line-height: 1.6;
        }
        
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .markdown-content p {
            margin-bottom: 1rem;
        }
        
        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        
        .markdown-content pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        /* Estilos para o menu lateral */
        .sidebar-item {
            transition: all 0.2s ease;
        }
        
        .sidebar-item:hover {
            background-color: #f3f4f6;
        }
        
        .sidebar-item.active {
            background-color: #dbeafe;
            color: #1d4ed8;
            border-right: 3px solid #1d4ed8;
        }
        
        /* Layout responsivo */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 50;
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }
            
            .sidebar-overlay.open {
                display: block;
            }
        }
        
        /* Esconder toggle mobile em desktop */
        .mobile-menu-toggle {
            display: none;
        }
        
        /* Estilos para upload de arquivo */
        .upload-zone-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        
        .file-preview-enter {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Estilos para drag and drop */
        .upload-zone.dragover {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(1.02);
        }
        
        .upload-zone.dragover .upload-placeholder {
            transform: scale(1.05);
        }
        
        /* Anima√ß√£o de hover para elementos decorativos */
        .upload-zone:hover .absolute.opacity-5 > div {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        /* Estilo para o bot√£o de sele√ß√£o de arquivo */
        .file-input-label {
            transition: all 0.2s ease;
        }
        
        .file-input-label:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Layout Principal com Menu Lateral -->
    <div class="flex h-screen">
        <!-- Overlay para mobile -->
        <div id="sidebar-overlay" class="sidebar-overlay"></div>
        
        <!-- Menu Lateral Fixo -->
        <aside class="sidebar w-64 bg-white shadow-lg border-r border-gray-200 flex-shrink-0">
            <!-- Logo/Header do Sidebar -->
            <div class="p-6 border-b border-gray-200">
                    <h1 class="text-xl font-semibold text-gray-900">
                    RAG-Demo
                    </h1>
                <p class="text-sm text-gray-600 mt-1">Ambiente Educacional</p>
                </div>
            
            <!-- Menu de Navega√ß√£o -->
            <nav class="p-4 space-y-2">
                <button id="upload-nav" class="sidebar-item active w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-left">
                    <i data-lucide="upload" class="w-5 h-5"></i>
                    <span>Upload</span>
                    </button>
                
                <button id="collections-nav" class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-left">
                    <i data-lucide="folder-open" class="w-5 h-5"></i>
                    <span>Collections</span>
                    </button>
                
                <button id="editor-nav" class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-left">
                    <i data-lucide="edit-3" class="w-5 h-5"></i>
                    <span>Editor</span>
                    </button>
                
                <button id="chat-nav" class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-left">
                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                    <span>Chat</span>
                    </button>
                
                <button id="history-nav" class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-left">
                    <i data-lucide="clock" class="w-5 h-5"></i>
                    <span>Hist√≥rico</span>
                    </button>
            </nav>
            
            <!-- Status de Conex√£o -->
            <div class="absolute bottom-4 left-4 right-4">
                <div id="status-indicator" class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="text-sm text-gray-600">Conectado</span>
                </div>
            </div>
        </aside>

        <!-- √Årea de Trabalho Principal -->
        <main class="main-content flex-1 flex flex-col ml-0 lg:ml-0">
                        <!-- Cabe√ßalho -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex justify-between items-center">
                    <!-- Mobile menu toggle -->
                    <button id="mobile-menu-toggle" class="mobile-menu-toggle lg:hidden p-2 rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    
                    <div>
                        <h2 id="page-title" class="text-xl font-semibold text-gray-900">Upload de Documento</h2>
                        <p id="page-subtitle" class="text-sm text-gray-600">Fa√ßa upload de documentos para processamento</p>
                    </div>
                    
                    <!-- Status de Vetoriza√ß√£o -->
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">Status:</span>
                            <div id="vectorization-status" class="text-sm text-gray-600">
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                                    <span>Aguardando...</span>
                                </div>
                            </div>
                        </div>
                            </div>
            </header>
                    
            <!-- Conte√∫do Principal -->
            <div class="flex-1 overflow-auto p-6">
                <!-- Tela de Upload -->
                <div id="upload-content" class="content-section">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="space-y-6">
                            <!-- File Upload -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Selecione um arquivo PDF, DOCX, TXT ou MD
                                </label>
                                <div id="upload-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center transition-all duration-200 hover:border-blue-400 hover:bg-blue-50 relative overflow-hidden">
                                    <!-- Background decoration -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute top-4 left-4 w-16 h-16 bg-blue-500 rounded-full"></div>
                                        <div class="absolute bottom-4 right-4 w-12 h-12 bg-green-500 rounded-full"></div>
                                        <div class="absolute top-1/2 left-1/4 w-8 h-8 bg-purple-500 rounded-full"></div>
                                        <div class="absolute top-1/3 right-1/3 w-10 h-10 bg-yellow-500 rounded-full"></div>
                                    </div>
                                    
                                    <input type="file" id="file-input" class="hidden" accept=".pdf,.docx,.txt,.md">
                                    <div id="upload-placeholder" class="space-y-4 relative z-10">
                                        <div class="flex flex-col items-center space-y-3">
                                            <div class="relative">
                                                <i data-lucide="upload-cloud" class="mx-auto h-16 w-16 text-gray-400"></i>
                                                <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
                                                    <i data-lucide="plus" class="w-3 h-3 text-white"></i>
                                                </div>
                                            </div>
                                            <div class="text-center space-y-2">
                                                <label for="file-input" class="file-input-label relative cursor-pointer bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors inline-flex items-center space-x-2">
                                                    <i data-lucide="file-plus" class="w-4 h-4"></i>
                                                    <span>Selecionar arquivo</span>
                                                </label>
                                                <p class="text-sm text-gray-500">ou arraste e solte aqui</p>
                                                <p class="text-xs text-gray-400">PDF, DOCX, TXT ou MD (m√°x. 10MB)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="file-preview" class="hidden relative z-10">
                                        <div class="flex items-center justify-between p-6 bg-white rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center space-x-4">
                                                <div class="flex-shrink-0">
                                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                                        <i data-lucide="file-text" class="h-6 w-6 text-blue-600"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div id="file-name" class="text-sm font-semibold text-gray-900 truncate"></div>
                                                    <div id="file-size" class="text-xs text-gray-500 mt-1"></div>
                                                    <div class="flex items-center space-x-2 mt-2">
                                                        <div class="w-full bg-gray-200 rounded-full h-1">
                                                            <div class="bg-blue-600 h-1 rounded-full" style="width: 100%"></div>
                                                        </div>
                                                        <span class="text-xs text-green-600 font-medium">Pronto</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <button id="remove-file" class="flex-shrink-0 p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors">
                                                <i data-lucide="x" class="h-5 w-5"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div id="file-info" class="mt-2 text-sm text-gray-600 hidden"></div>
                                
                                <!-- Lista de arquivos preparados para processamento -->
                                <div id="files-queue" class="hidden mt-4">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <div class="flex items-center space-x-2 mb-3">
                                            <i data-lucide="clock" class="w-5 h-5 text-blue-600"></i>
                                            <h4 class="text-sm font-semibold text-blue-800">Arquivos Preparados para Processamento</h4>
                                        </div>
                                        <div id="files-list" class="space-y-2">
                                            <!-- Arquivos ser√£o adicionados dinamicamente aqui -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Collection Selection and LLM Enhancement -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Collection:</label>
                                    <select id="upload-collection-select" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                        <option value="">Carregando collections...</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Selecione a collection para armazenar os documentos</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Melhorar com LLM:</label>
                                    <select id="upload-enhance" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                        <option value="true">Sim</option>
                                        <option value="false">N√£o</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Usa LLM para melhorar o conte√∫do</p>
                                </div>
                            </div>

                            <!-- Upload Button -->
                            <button id="upload-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                Processar Documento
                            </button>

                            <!-- Progress -->
                            <div id="upload-progress" class="hidden">
                                <div class="bg-gray-100 rounded-lg p-4 border border-gray-200">
                                    <div class="flex items-center space-x-3 mb-3">
                                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                                        <span class="text-sm font-medium text-gray-700">Processando documento...</span>
                                    </div>
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                    <div id="progress-text" class="text-sm text-gray-600 mt-2">Iniciando processamento...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Dashboard de Collections -->
                <div id="collections-content" class="content-section hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">Collections</h2>
                        </div>
                        
                        <!-- Filters and Actions -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Filtro por Modelo:</label>
                                <select id="model-filter" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    <option value="">Todos os modelos</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Filtrar por modelo de embedding</p>
                            </div>

                            <div class="flex items-end">
                                <button id="new-collection-btn" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                    Nova Collection
                                </button>
                            </div>
                        </div>
                        
                        <!-- Lista de Collections -->
                        <div id="collections-list" class="space-y-4">
                            <!-- Collections ser√£o carregadas aqui -->
                        </div>
                    </div>
                </div>

                <!-- Editor de Conte√∫do -->
                <div id="editor-content" class="content-section hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Editor de Perguntas e Respostas</h2>
                        
                        <div class="space-y-6">
                            <!-- Document Selection -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Collection:</label>
                                    <select id="editor-collection-select" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                        <option value="">Selecione uma collection...</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Collection para inserir os Q&As gerados</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Documento:</label>
                                    <select id="editor-document-select" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                        <option value="">Selecione um documento...</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Documento para gerar Q&As</p>
                                </div>
                            </div>

                            <!-- Document Info -->
                            <div id="document-info" class="hidden">
                                <h3 class="text-lg font-medium text-gray-900 mb-3">üìä M√©tricas do Documento</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600" id="char-count">0</div>
                                        <div class="text-sm text-gray-600">Caracteres</div>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <div class="text-2xl font-bold text-green-600" id="word-count">0</div>
                                        <div class="text-sm text-gray-600">Palavras</div>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <div class="text-2xl font-bold text-purple-600" id="unique-words">0</div>
                                        <div class="text-sm text-gray-600">Palavras √önicas</div>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <div class="text-2xl font-bold text-orange-600" id="avg-word-length">0</div>
                                        <div class="text-sm text-gray-600">Tamanho M√©dio</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Q&A Generation Parameters -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="text-lg font-medium text-gray-900 mb-3">‚öôÔ∏è Configura√ß√µes de Gera√ß√£o</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Q&As:</label>
                                        <input type="number" id="num-questions" min="1" max="500" value="50" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Dificuldade:</label>
                                        <select id="difficulty" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                            <option value="Iniciante">Iniciante</option>
                                            <option value="Intermedi√°rio" selected>Intermedi√°rio</option>
                                            <option value="Avan√ßado">Avan√ßado</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Criatividade:</label>
                                        <input type="range" id="temperature" min="0.0" max="1.0" step="0.1" value="0.5" class="w-full">
                                        <div class="text-xs text-gray-500 mt-1" id="temperature-value">0.5</div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Palavras-chave:</label>
                                        <input type="text" id="context-keywords" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="termo1, termo2, termo3">
                                        <p class="text-xs text-gray-500 mt-1">Separadas por v√≠rgula</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Custom Prompt -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Instru√ß√µes para gera√ß√£o:</label>
                                <textarea id="custom-prompt" rows="6" class="w-full border border-gray-300 rounded-md px-3 py-2 font-mono text-sm" placeholder="Instru√ß√µes personalizadas para gera√ß√£o de Q&A...">Voc√™ √© um especialista em cria√ß√£o de conte√∫dos educacionais. 
Gere no m√≠nimo {num_questions} perguntas e respostas baseadas no documento abaixo:

REGRAS:
1. Foco nos contextos: {context_keywords} (priorizar estes termos)
2. Formato obrigat√≥rio: 
**Pergunta {{n√∫mero}}:** [texto] \n\n **Resposta {{n√∫mero}}:** [texto]
3. N√≠vel de detalhe: adequado para profissionais de n√≠vel {difficulty}
4. Inclua exemplos quando relevante

DOCUMENTO:
{document_text}</textarea>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex space-x-4">
                                <button id="generate-qa-btn" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 font-medium">
                                    üöÄ Gerar Q&As
                                </button>
                                <button id="vectorize-content-btn" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 font-medium">
                                    üìä Vetorizar Conte√∫do
                                </button>
                            </div>

                            <!-- Progress Section -->
                            <div id="qa-progress" class="hidden">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex items-center space-x-3">
                                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                                        <div>
                                            <div class="text-sm font-medium text-blue-900" id="progress-status">Processando...</div>
                                            <div class="text-xs text-blue-700" id="progress-details">Iniciando gera√ß√£o de Q&As...</div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="w-full bg-blue-200 rounded-full h-2">
                                            <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Generated Q&A Results -->
                            <div id="qa-results" class="hidden">
                                <div class="border-t pt-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-lg font-medium text-gray-900">üìã Q&As Gerados</h3>
                                        <div class="flex space-x-2">
                                            <button id="download-qa-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 text-sm">
                                                üíæ Baixar Q&As
                                            </button>
                                            <button id="create-embeddings-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 text-sm">
                                                üîó Criar Embeddings
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Tabs para visualiza√ß√£o -->
                                    <div class="mb-4">
                                        <div class="border-b border-gray-200">
                                            <nav class="-mb-px flex space-x-8">
                                                <button id="qa-tab-formatted" class="qa-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-tab="formatted">
                                                    üìã Visualiza√ß√£o Formatada
                                                </button>
                                                <button id="qa-tab-markdown" class="qa-tab-btn border-indigo-500 text-indigo-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-tab="markdown">
                                                    üìù Markdown Raw
                                                </button>
                                            </nav>
                                        </div>
                                    </div>
                                    
                                    <!-- Conte√∫do formatado -->
                                    <div id="qa-content-formatted" class="qa-tab-content">
                                        <div id="qa-list" class="space-y-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-4"></div>
                                    </div>
                                    
                                    <!-- Conte√∫do markdown raw -->
                                    <div id="qa-content-markdown" class="qa-tab-content hidden">
                                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-sm font-medium text-gray-700">Markdown para Embeddings:</span>
                                                <button id="copy-markdown-btn" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                                    üìã Copiar
                                                </button>
                                            </div>
                                            <textarea id="qa-markdown-content" class="w-full h-96 font-mono text-sm border border-gray-300 rounded-md px-3 py-2" readonly></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat -->
                <div id="chat-content" class="content-section hidden">
                    <div class="bg-white rounded-lg shadow flex flex-col h-[600px]">
                        <!-- Chat Header -->
                        <div class="border-b px-6 py-4">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-semibold text-gray-900">Chat RAG</h2>
                                <div class="flex items-center space-x-4">
                                    <span id="current-session" class="text-sm text-gray-600">Sess√£o: Nova</span>
                                    <button id="new-session-btn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                        Nova Sess√£o
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Collection Selection for Chat -->
                            <div class="grid grid-cols-1 gap-4 mt-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Collection:</label>
                                    <select id="chat-collection-select" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                        <option value="">Todas as collections</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Filtrar por collection</p>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4">
                            <div class="text-center text-gray-500 text-sm">
                                Inicie uma conversa fazendo uma pergunta...
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <div class="border-t px-6 py-4">
                            <div class="flex space-x-4">
                                <input type="text" id="chat-input" class="flex-1 border border-gray-300 rounded-md px-3 py-2" placeholder="Digite sua pergunta...">
                                <button id="send-message-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                    Enviar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hist√≥rico -->
                <div id="history-content" class="content-section hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Hist√≥rico de Sess√µes</h2>
                        
                        <div id="sessions-list" class="space-y-4">
                            <!-- Sess√µes ser√£o carregadas aqui -->
            </div>
        </div>
                </div>
            </div>
        </main>
    </div>

            <!-- Toast Notifications -->
        <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Modal para Nova Collection -->
    <div id="collection-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="px-6 py-4 border-b">
                    <h3 class="text-lg font-medium text-gray-900">Nova Collection</h3>
                </div>
                
                <div class="px-6 py-4">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Collection:</label>
                            <input type="text" id="collection-name-input" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="ex: aula_pln_2024" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o:</label>
                            <textarea id="collection-description-input" class="w-full border border-gray-300 rounded-md px-3 py-2" rows="2" placeholder="Descri√ß√£o da collection..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Modelo de Embedding:</label>
                            <select id="collection-embedding-model-select" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                <option value="">Selecione um modelo...</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Modelo de embedding para esta collection</p>
                        </div>
                        
                        <div id="collection-model-info" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <h4 class="text-sm font-medium text-blue-900 mb-2">Informa√ß√µes do Modelo</h4>
                            <div class="space-y-1 text-sm text-blue-800">
                                <div><span class="font-medium">Nome:</span> <span id="collection-model-name">-</span></div>
                                <div><span class="font-medium">Dimens√£o:</span> <span id="collection-model-dimension">-</span></div>
                                <div><span class="font-medium">Provider:</span> <span id="collection-model-provider">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="px-6 py-4 border-t flex justify-end space-x-3">
                    <button id="cancel-collection-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        Cancelar
                    </button>
                    <button id="create-collection-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Criar Collection
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- JavaScript -->
    <script>
        // Socket.IO connection
        const socket = io();
        
        // Global variables
        let currentSessionId = null;
        let isProcessing = false;
        let collections = [];
        let documents = [];
        let embeddingModels = [];
        
        // DOM elements
        const navButtons = document.querySelectorAll('.sidebar-item');
        const contentSections = document.querySelectorAll('.content-section');
        const statusIndicator = document.getElementById('status-indicator');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        
        // Navigation functionality
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const navId = button.id.replace('-nav', '');
                
                // Update active nav
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Show content
                contentSections.forEach(section => section.classList.add('hidden'));
                document.getElementById(`${navId}-content`).classList.remove('hidden');
                
                // Update page title and subtitle
                updatePageHeader(navId);
                
                // Close mobile menu if open
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('open');
                }
            });
        });
        
        // Mobile menu toggle
        mobileMenuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('open');
        });
        
        // Close mobile menu when clicking overlay
        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('open');
        });
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !mobileMenuToggle.contains(e.target)) {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('open');
            }
        });
        
        function updatePageHeader(navId) {
            const pageTitle = document.getElementById('page-title');
            const pageSubtitle = document.getElementById('page-subtitle');
            
            const headers = {
                'upload': {
                    title: 'Upload de Documento',
                    subtitle: 'Fa√ßa upload de documentos para processamento'
                },
                'collections': {
                    title: 'Collections',
                    subtitle: 'Gerencie suas collections de documentos'
                },
                'editor': {
                    title: 'Editor de Conte√∫do',
                    subtitle: 'Crie e edite perguntas e respostas'
                },
                'chat': {
                    title: 'Chat RAG',
                    subtitle: 'Converse com seus documentos'
                },
                'history': {
                    title: 'Hist√≥rico',
                    subtitle: 'Visualize sess√µes anteriores'
                }
            };
            
            if (headers[navId]) {
                pageTitle.textContent = headers[navId].title;
                pageSubtitle.textContent = headers[navId].subtitle;
            }
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg transform translate-x-full transition-all duration-300`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 5000);
            
            // Reinitialize icons
            lucide.createIcons();
        }
        
        // Socket.IO events
        socket.on('connect', () => {
            statusIndicator.innerHTML = '<div class="w-2 h-2 bg-green-500 rounded-full"></div><span class="text-sm text-gray-600">Conectado</span>';
        });
        
        socket.on('disconnect', () => {
            statusIndicator.innerHTML = '<div class="w-2 h-2 bg-red-500 rounded-full"></div><span class="text-sm text-gray-600">Desconectado</span>';
        });
        
        socket.on('chat_response', (data) => {
            addChatMessage('assistant', data.response, data);
            isProcessing = false;
            updateSendButton();
        });
        
        socket.on('chat_error', (data) => {
            addChatMessage('error', `Erro: ${data.error}`);
            isProcessing = false;
            updateSendButton();
        });
        
        // File upload functionality - will be initialized in DOMContentLoaded
        let fileInput, fileInfo, uploadBtn, uploadProgress, progressBar, progressText;
        let uploadZone, uploadPlaceholder, filePreview, fileName, fileSize, removeFileBtn;
        let filesQueue, filesList;
        let selectedFiles = []; // Array para armazenar arquivos selecionados
        
        // Initialize upload functionality
        function initializeUpload() {
            // Get DOM elements
            fileInput = document.getElementById('file-input');
            fileInfo = document.getElementById('file-info');
            uploadBtn = document.getElementById('upload-btn');
            console.log('üîç DEBUG: uploadBtn encontrado?', !!uploadBtn, uploadBtn);
            uploadProgress = document.getElementById('upload-progress');
            progressBar = document.getElementById('progress-bar');
            progressText = document.getElementById('progress-text');
            uploadZone = document.getElementById('upload-zone');
            uploadPlaceholder = document.getElementById('upload-placeholder');
            filePreview = document.getElementById('file-preview');
            fileName = document.getElementById('file-name');
            fileSize = document.getElementById('file-size');
            removeFileBtn = document.getElementById('remove-file');
            filesQueue = document.getElementById('files-queue');
            filesList = document.getElementById('files-list');
            

            

            

            
            // Drag and drop functionality
            if (uploadZone) {
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });
                
                uploadZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                });
                
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && fileInput) {
                        fileInput.files = files;
                        handleFileSelection(files[0]);
                    }
                });
            }
            
            // File input change event
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    handleFileSelection(file);
                });
            }
            
            // Remove file button event
            if (removeFileBtn) {
                removeFileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearFileSelection();
                    showToast('Arquivo removido com sucesso', 'success');
                });
            }
        }
        
        function handleFileSelection(file) {
            console.log('üìÅ Arquivo selecionado:', file ? file.name : 'null');
            console.log('üéØ Elementos UI:', {
                fileName: !!fileName,
                fileSize: !!fileSize,
                uploadPlaceholder: !!uploadPlaceholder,
                filePreview: !!filePreview
            });
            
            if (file && fileName && fileSize && uploadPlaceholder && filePreview) {
                
                // Show file preview
                fileName.textContent = file.name;
                fileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                
                // Update file icon based on type
                const fileIcon = filePreview.querySelector('i[data-lucide]');
                const extension = file.name.split('.').pop().toLowerCase();
                
                // Set appropriate icon and color based on file type
                let iconName = 'file-text';
                let iconColor = 'text-blue-600';
                let bgColor = 'bg-blue-100';
                
                // Only update if icon exists
                if (fileIcon) {
                    fileIcon.className = '';
                }
                
                switch(extension) {
                    case 'pdf':
                        iconName = 'file-text';
                        iconColor = 'text-red-600';
                        bgColor = 'bg-red-100';
                        break;
                    case 'docx':
                        iconName = 'file-text';
                        iconColor = 'text-blue-600';
                        bgColor = 'bg-blue-100';
                        break;
                    case 'txt':
                        iconName = 'file-text';
                        iconColor = 'text-gray-600';
                        bgColor = 'bg-gray-100';
                        break;
                    case 'md':
                        iconName = 'file-text';
                        iconColor = 'text-purple-600';
                        bgColor = 'bg-purple-100';
                        break;
                    default:
                        iconName = 'file-text';
                        iconColor = 'text-gray-600';
                        bgColor = 'bg-gray-100';
                }
                
                // Update icon container background
                const iconContainer = filePreview.querySelector('.w-12.h-12');
                if (iconContainer) {
                    iconContainer.className = `w-12 h-12 ${bgColor} rounded-lg flex items-center justify-center`;
                }
                
                // Update icon
                if (fileIcon) {
                    fileIcon.className = `h-6 w-6 ${iconColor}`;
                    fileIcon.setAttribute('data-lucide', iconName);
                }
                
                // Reinitialize Lucide icons (removed due to CSP)
                // lucide.createIcons();
                

                

                
                uploadPlaceholder.classList.add('hidden');
                filePreview.classList.remove('hidden');
                filePreview.classList.add('file-preview-enter');
                
                // Add success animation
                if (uploadZone) {
                    uploadZone.classList.add('border-green-400', 'bg-green-50');
                    setTimeout(() => {
                        uploadZone.classList.remove('border-green-400', 'bg-green-50');
                    }, 1000);
                }
                
                // Update file info for backward compatibility
                if (fileInfo) {
                    fileInfo.textContent = `Arquivo selecionado: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                    fileInfo.classList.remove('hidden');
                }
                
                // Add file to queue
                console.log('üìù Adicionando arquivo √† fila...');
                addFileToQueue(file);
            }
        }
        
        function clearFileSelection() {
            if (fileInput) fileInput.value = '';
            if (uploadPlaceholder) uploadPlaceholder.classList.remove('hidden');
            if (filePreview) filePreview.classList.add('hidden');
            if (fileInfo) fileInfo.classList.add('hidden');
            
            // Clear the current file preview but keep the queue
        }
        
        function addFileToQueue(file) {
            console.log('üìã Adicionando √† fila:', file.name);
            
            // Create unique ID for file
            const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Add to selectedFiles array
            selectedFiles.push({
                id: fileId,
                file: file,
                name: file.name,
                size: file.size,
                status: 'ready' // ready, processing, completed, error
            });
            
            console.log('üìä Total de arquivos na fila:', selectedFiles.length);
            updateFilesQueue();
        }
        
        // Make this function globally available
        window.removeFileFromQueue = function(fileId) {
            selectedFiles = selectedFiles.filter(f => f.id !== fileId);
            updateFilesQueue();

        }
        
        function updateFilesQueue() {
            console.log('üîÑ Atualizando fila de arquivos...');
            console.log('üéØ Elementos fila:', {
                filesQueue: !!filesQueue,
                filesList: !!filesList
            });
            console.log('üìä Arquivos na fila:', selectedFiles.length);
            
            if (!filesQueue || !filesList) {
                console.log('‚ùå Elementos da fila n√£o encontrados!');
                return;
            }
            
            if (selectedFiles.length === 0) {
                console.log('üì≠ Fila vazia, ocultando...');
                filesQueue.classList.add('hidden');
                return;
            }
            
            console.log('üìã Mostrando fila com arquivos...');
            filesQueue.classList.remove('hidden');
            filesList.innerHTML = '';
            
            selectedFiles.forEach(fileItem => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200';
                
                const statusColor = {
                    'ready': 'text-blue-600 bg-blue-100',
                    'processing': 'text-yellow-600 bg-yellow-100',
                    'completed': 'text-green-600 bg-green-100',
                    'error': 'text-red-600 bg-red-100'
                };
                
                const statusText = {
                    'ready': 'Pronto',
                    'processing': 'Processando',
                    'completed': 'Completo',
                    'error': 'Erro'
                };
                
                fileDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <i data-lucide="file-text" class="w-5 h-5 text-gray-500"></i>
                        <div>
                            <div class="text-sm font-medium text-gray-900">${fileItem.name}</div>
                            <div class="text-xs text-gray-500">${(fileItem.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor[fileItem.status]}">
                            ${statusText[fileItem.status]}
                        </span>
                        <button onclick="removeFileFromQueue('${fileItem.id}')" class="p-1 text-gray-400 hover:text-red-500 transition-colors">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                
                filesList.appendChild(fileDiv);
            });
            
            // Reinitialize Lucide icons (removed due to CSP)
            // lucide.createIcons();
            
            // Upload button event
            console.log('üîç DEBUG: Verificando uploadBtn para event listener...', !!uploadBtn);
            if (uploadBtn) {
                console.log('‚úÖ Bot√£o upload encontrado, adicionando event listener');
                uploadBtn.addEventListener('click', async () => {
                    console.log('üöÄ Bot√£o upload clicado!');
                    console.log('üìä Estado atual:', {
                        fileInput: !!fileInput,
                        files: fileInput?.files?.length || 0,
                        selectedFiles: selectedFiles.length
                    });
                    
                    // Usar arquivo da fila em vez de fileInput
                    const file = selectedFiles.length > 0 ? selectedFiles[0].file : fileInput.files[0];
                    const collectionSelect = document.getElementById('upload-collection-select');
                    
                    console.log('üìÅ Arquivo para upload:', file ? file.name : 'nenhum');
                    console.log('üìã Collection selecionada:', collectionSelect.value);
                    
                    if (!file) {
                        console.log('‚ùå Nenhum arquivo encontrado');
                        showToast('Selecione um arquivo primeiro', 'warning');
                        return;
                    }
                    
                    if (!collectionSelect.value) {
                        console.log('‚ùå Collection n√£o selecionada');
                        showToast('Selecione uma collection primeiro', 'warning');
                        return;
                    }
                    
                    console.log('‚úÖ Todas as valida√ß√µes passaram, iniciando upload...');
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('collection_name', collectionSelect.value);
                    formData.append('enhance', document.getElementById('upload-enhance').value);
                    
                    uploadBtn.disabled = true;
                    uploadProgress.classList.remove('hidden');
                    updateVectorizationStatus('processing', 'Processando documento...');
                    
                    // Simulate progress updates
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += Math.random() * 15;
                        if (progress > 90) progress = 90;
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `Processando... ${Math.round(progress)}%`;
                    }, 500);
                    
                    try {
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            clearInterval(progressInterval);
                            progressBar.style.width = '100%';
                            progressText.textContent = 'Upload conclu√≠do!';
                            
                            // Show success in progress area
                            const progressContainer = uploadProgress.querySelector('.bg-gray-100');
                            progressContainer.className = 'bg-green-50 rounded-lg p-4 border border-green-200';
                            progressContainer.innerHTML = `
                                <div class="flex items-center space-x-3 mb-3">
                                    <i data-lucide="check-circle" class="h-5 w-5 text-green-500"></i>
                                    <span class="text-sm font-medium text-green-700">Documento processado com sucesso!</span>
                                </div>
                                <div class="text-sm text-green-600">Collection: ${result.collection}</div>
                                <div class="text-sm text-green-600">Chunks: ${result.chunks}</div>
                            `;
                            
                            // Update status
                            updateVectorizationStatus('success', `Documento processado com sucesso!`);
                            
                            // Show success message
                            showToast(result.message, 'success');
                            
                            // Reload collections to show updated list
                            await loadCollections();
                            
                            // If we're on the collections page, refresh the current view
                            const collectionsContent = document.getElementById('collections-content');
                            if (!collectionsContent.classList.contains('hidden')) {
                                updateCollectionsList();
                            }
                            
                            // Reset form
                            clearFileSelection();
                            
                            setTimeout(() => {
                                uploadProgress.classList.add('hidden');
                                progressBar.style.width = '0%';
                                progressText.textContent = 'Iniciando processamento...';
                                // Reset progress container to original state
                                progressContainer.className = 'bg-gray-100 rounded-lg p-4 border border-gray-200';
                                progressContainer.innerHTML = `
                                    <div class="flex items-center space-x-3 mb-3">
                                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                                        <span class="text-sm font-medium text-gray-700">Processando documento...</span>
                                    </div>
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                    <div id="progress-text" class="text-sm text-gray-600 mt-2">Iniciando processamento...</div>
                                `;
                            }, 3000);
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (error) {
                        clearInterval(progressInterval);
                        progressText.textContent = `Erro: ${error.message}`;
                        updateVectorizationStatus('error', `Erro no upload: ${error.message}`);
                        showToast(`Erro no upload: ${error.message}`, 'error');
                        
                        // Show error in progress area
                        const progressContainer = uploadProgress.querySelector('.bg-gray-100');
                        progressContainer.className = 'bg-red-50 rounded-lg p-4 border border-red-200';
                        progressContainer.innerHTML = `
                            <div class="flex items-center space-x-3 mb-3">
                                <i data-lucide="alert-circle" class="h-5 w-5 text-red-500"></i>
                                <span class="text-sm font-medium text-red-700">Erro no processamento</span>
                            </div>
                            <div class="text-sm text-red-600">${error.message}</div>
                        `;
                    } finally {
                        clearInterval(progressInterval);
                        uploadBtn.disabled = false;
                    }
                });
            } else {
                console.log('‚ùå Bot√£o upload N√ÉO encontrado! ID:', 'upload-btn');
            }
        }
        
        // Editor functionality
        const generateQaBtn = document.getElementById('generate-qa-btn');
        const vectorizeContentBtn = document.getElementById('vectorize-content-btn');
        const qaResults = document.getElementById('qa-results');
        const qaList = document.getElementById('qa-list');
        const qaProgress = document.getElementById('qa-progress');
        const downloadQaBtn = document.getElementById('download-qa-btn');
        
        // Temperature slider
        const temperatureSlider = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperature-value');
        if (temperatureSlider && temperatureValue) {
            temperatureSlider.addEventListener('input', () => {
                temperatureValue.textContent = temperatureSlider.value;
            });
        }
        
        // Collection selection change handler
        const editorCollectionSelect = document.getElementById('editor-collection-select');
        if (editorCollectionSelect) {
            editorCollectionSelect.addEventListener('change', async () => {
                const selectedCollection = editorCollectionSelect.value;
                console.log('üîÑ Collection selecionada:', selectedCollection);
                
                if (selectedCollection) {
                    // Recarregar documentos para a collection selecionada
                    await loadDocumentsForCollection(selectedCollection);
                } else {
                    // Limpar seletor de documentos
                    updateDocumentSelect([]);
                    hideDocumentInfo();
                }
            });
        }

        // Document selection change handler
        const editorDocumentSelect = document.getElementById('editor-document-select');
        if (editorDocumentSelect) {
            editorDocumentSelect.addEventListener('change', async () => {
                const selectedDocument = editorDocumentSelect.value;
                if (selectedDocument) {
                    await loadDocumentInfo(selectedDocument);
                } else {
                    hideDocumentInfo();
                }
            });
        }
        
        if (generateQaBtn) {
            generateQaBtn.addEventListener('click', async () => {
                const collectionSelect = document.getElementById('editor-collection-select');
                const documentSelect = document.getElementById('editor-document-select');
                
                if (!collectionSelect.value) {
                    showToast('Selecione uma collection primeiro', 'warning');
                    return;
                }
                
                if (!documentSelect.value) {
                    showToast('Selecione um documento primeiro', 'warning');
                    return;
                }
                
                // Get form values
                const numQuestions = parseInt(document.getElementById('num-questions').value) || 50;
                const difficulty = document.getElementById('difficulty').value;
                const temperature = parseFloat(document.getElementById('temperature').value) || 0.5;
                const contextKeywords = document.getElementById('context-keywords').value;
                const customPrompt = document.getElementById('custom-prompt').value;
                
                generateQaBtn.disabled = true;
                generateQaBtn.textContent = 'Gerando...';
                showQaProgress('Iniciando gera√ß√£o de Q&As...');
                
                try {
                    // Obter o conte√∫do do documento selecionado
                    const contentResponse = await fetch(`/api/collections/${collectionSelect.value}/content?document=${encodeURIComponent(documentSelect.value)}`);
                    const contentResult = await contentResponse.json();
                    
                    if (!contentResult.success) {
                        throw new Error('Erro ao obter conte√∫do do documento');
                    }
                    
                    if (!contentResult.content.trim()) {
                        showToast('O documento selecionado n√£o possui conte√∫do para gerar Q&A', 'warning');
                        return;
                    }
                    
                    // Gerar Q&A
                    const response = await fetch('/api/qa-generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: contentResult.content,
                            collection_name: collectionSelect.value,
                            num_questions: numQuestions,
                            context_keywords: contextKeywords,
                            difficulty: difficulty,
                            temperature: temperature,
                            custom_prompt: customPrompt
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        displayQAResults(result.qa_content);
                        hideQaProgress();
                        showToast(`${result.qa_count} Q&As gerados com sucesso`, 'success');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    hideQaProgress();
                    showToast(`Erro ao gerar Q&A: ${error.message}`, 'error');
                } finally {
                    generateQaBtn.disabled = false;
                    generateQaBtn.textContent = 'üöÄ Gerar Q&As';
                }
            });
        }
        
        if (vectorizeContentBtn) {
            vectorizeContentBtn.addEventListener('click', async () => {
                const collectionSelect = document.getElementById('editor-collection-select');
                
                if (!collectionSelect.value) {
                    showToast('Selecione uma collection primeiro', 'warning');
                    return;
                }
                
                vectorizeContentBtn.disabled = true;
                vectorizeContentBtn.textContent = 'Vetorizando...';
                showQaProgress('Vetorizando conte√∫do...');
                
                try {
                    // Obter conte√∫do da collection
                    const contentResponse = await fetch(`/api/collections/${collectionSelect.value}/content`);
                    const contentResult = await contentResponse.json();
                    
                    if (!contentResult.success) {
                        throw new Error('Erro ao obter conte√∫do da collection');
                    }
                    
                    if (!contentResult.content.trim()) {
                        showToast('A collection selecionada n√£o possui documentos para vetorizar', 'warning');
                        return;
                    }
                    
                    // Aqui voc√™ pode implementar a l√≥gica de vetoriza√ß√£o se necess√°rio
                    showToast('Conte√∫do j√° est√° vetorizado na collection', 'info');
                    
                } catch (error) {
                    showToast(`Erro ao vetorizar conte√∫do: ${error.message}`, 'error');
                } finally {
                    vectorizeContentBtn.disabled = false;
                    vectorizeContentBtn.textContent = 'üìä Vetorizar Conte√∫do';
                    hideQaProgress();
                }
            });
        }
        
        // Chat functionality
        const chatInput = document.getElementById('chat-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const chatMessages = document.getElementById('chat-messages');
        const newSessionBtn = document.getElementById('new-session-btn');
        const currentSessionSpan = document.getElementById('current-session');
        
        newSessionBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST'
                });
                
                const result = await response.json();
                currentSessionId = result.session_id;
                currentSessionSpan.textContent = `Sess√£o: ${currentSessionId.substring(0, 8)}...`;
                
                // Clear chat
                chatMessages.innerHTML = '<div class="text-center text-gray-500 text-sm">Nova sess√£o iniciada...</div>';
                
                // Load sessions
                loadSessions();
            } catch (error) {
                console.error('Erro ao criar sess√£o:', error);
            }
        });
        
        sendMessageBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isProcessing) return;
            
            if (!currentSessionId) {
                // Create new session if none exists
                try {
                    const response = await fetch('/api/sessions', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    currentSessionId = result.session_id;
                    currentSessionSpan.textContent = `Sess√£o: ${currentSessionId.substring(0, 8)}...`;
                } catch (error) {
                    console.error('Erro ao criar sess√£o:', error);
                    return;
                }
            }
            
            // Add user message
            addChatMessage('user', message);
            
            // Clear input
            chatInput.value = '';
            
            // Send via WebSocket
            isProcessing = true;
            updateSendButton();
            
            socket.emit('chat_message', {
                message: message,
                session_id: currentSessionId,
                collection_name: document.getElementById('chat-collection-select').value
            });
        }
        
        function addChatMessage(role, content, metadata = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            const isUser = role === 'user';
            const isError = role === 'error';
            
            let messageContent = `<div class="markdown-content">${marked.parse(content)}</div>`;
            
            // Adicionar informa√ß√µes da collection se dispon√≠vel
            if (metadata && metadata.embedding_info && role === 'assistant') {
                const embeddingInfo = metadata.embedding_info;
                messageContent += `
                    <div class="mt-2 pt-2 border-t border-gray-200 text-xs text-gray-500">
                        <div class="flex items-center space-x-2">
                            <span class="font-medium">Collection:</span>
                            <span>${embeddingInfo.collection_name}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-medium">Embedding:</span>
                            <span>${embeddingInfo.model_name} (${embeddingInfo.provider})</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-medium">Dimens√£o:</span>
                            <span>${embeddingInfo.dimension}</span>
                        </div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                        isUser ? 'bg-blue-600 text-white' : 
                        isError ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-900'
                    }">
                        ${messageContent}
                    </div>
                </div>
            `;
            
            // Remove placeholder if exists
            const placeholder = chatMessages.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Highlight code blocks
            messageDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }
        
        function updateSendButton() {
            sendMessageBtn.disabled = isProcessing;
            sendMessageBtn.textContent = isProcessing ? 'Enviando...' : 'Enviar';
        }
        
        function updateVectorizationStatus(status, message) {
            const statusDiv = document.getElementById('vectorization-status');
            const icon = status === 'success' ? 'bg-green-500' : 
                        status === 'error' ? 'bg-red-500' : 
                        status === 'processing' ? 'bg-yellow-500' : 'bg-gray-400';
            
            statusDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 ${icon} rounded-full"></div>
                    <span class="text-sm text-gray-600">${message}</span>
                </div>
            `;
        }
        
        function displayQAResults(qaContent) {
            if (!qaContent) {
                showToast('Nenhum Q&A foi gerado', 'warning');
                return;
            }
            
            // Store Q&A content globally
            window.currentQAContent = qaContent;
            
            // Parse Q&A content
            const qaPairs = parseQAContent(qaContent);
            
            // Display in formatted view
            const qaList = document.getElementById('qa-list');
            const qaResults = document.getElementById('qa-results');
            
            qaList.innerHTML = '';
            
            qaPairs.forEach((pair, index) => {
                const qaDiv = document.createElement('div');
                qaDiv.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm';
                qaDiv.innerHTML = `
                    <div class="mb-3">
                        <h4 class="font-medium text-gray-900 flex items-center">
                            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded mr-2">Q${index + 1}</span>
                            Pergunta ${index + 1}
                        </h4>
                        <div class="text-gray-700 mt-1 pl-4 border-l-2 border-blue-200">${pair.question}</div>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900 flex items-center">
                            <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded mr-2">R${index + 1}</span>
                            Resposta ${index + 1}
                        </h4>
                        <div class="text-gray-700 mt-1 pl-4 border-l-2 border-green-200">${pair.answer}</div>
                    </div>
                `;
                qaList.appendChild(qaDiv);
            });
            
            // Display raw markdown
            const qaMarkdownContent = document.getElementById('qa-markdown-content');
            qaMarkdownContent.value = qaContent;
            
            qaResults.classList.remove('hidden');
            
            // Setup buttons
            setupDownloadButton(qaContent);
            setupTabHandlers();
            setupCopyButton();
            setupEmbeddingsButton();
        }
        
        function parseQAContent(qaContent) {
            const qaPairs = [];
            const pattern = /\*\*Pergunta (\d+):\*\*(.*?)(?=\*\*Resposta \1:\*\*|\*\*Pergunta \d+:\*\*|\Z)/gs;
            
            let match;
            while ((match = pattern.exec(qaContent)) !== null) {
                const questionNumber = match[1];
                const questionText = match[2].trim();
                
                // Find corresponding answer
                const answerPattern = new RegExp(`\\*\\*Resposta ${questionNumber}:\\*\\*(.*?)(?=\\*\\*Pergunta \\d+:\\*\\*|\\Z)`, 's');
                const answerMatch = qaContent.match(answerPattern);
                const answerText = answerMatch ? answerMatch[1].trim() : '';
                
                if (questionText && answerText) {
                    qaPairs.push({
                        question: questionText,
                        answer: answerText
                    });
                }
            }
            
            return qaPairs;
        }
        
        function setupDownloadButton(qaContent) {
            const downloadBtn = document.getElementById('download-qa-btn');
            if (downloadBtn) {
                downloadBtn.onclick = () => {
                    const blob = new Blob([qaContent], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `qas_gerados_${new Date().toISOString().split('T')[0]}.md`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };
            }
        }
        
        function showQaProgress(message) {
            const qaProgress = document.getElementById('qa-progress');
            const progressStatus = document.getElementById('progress-status');
            const progressDetails = document.getElementById('progress-details');
            
            if (qaProgress && progressStatus && progressDetails) {
                progressStatus.textContent = 'Processando...';
                progressDetails.textContent = message;
                qaProgress.classList.remove('hidden');
            }
        }
        
        function hideQaProgress() {
            const qaProgress = document.getElementById('qa-progress');
            if (qaProgress) {
                qaProgress.classList.add('hidden');
            }
        }
        
        async function loadDocumentInfo(documentName) {
            try {
                // Usar uma collection tempor√°ria para obter o conte√∫do
                const response = await fetch(`/api/collections/temp/content?document=${encodeURIComponent(documentName)}`);
                const result = await response.json();
                
                if (result.success && result.content) {
                    const content = result.content;
                    const words = content.split(/\s+/);
                    const uniqueWords = new Set(words);
                    
                    document.getElementById('char-count').textContent = content.length.toLocaleString('pt-BR');
                    document.getElementById('word-count').textContent = words.length.toLocaleString('pt-BR');
                    document.getElementById('unique-words').textContent = uniqueWords.size.toLocaleString('pt-BR');
                    document.getElementById('avg-word-length').textContent = 
                        (words.reduce((sum, word) => sum + word.length, 0) / words.length).toFixed(1);
                    
                    document.getElementById('document-info').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro ao carregar informa√ß√µes do documento:', error);
            }
        }
        
        function hideDocumentInfo() {
            document.getElementById('document-info').classList.add('hidden');
        }
        
        function setupTabHandlers() {
            const tabButtons = document.querySelectorAll('.qa-tab-btn');
            const tabContents = document.querySelectorAll('.qa-tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    
                    // Remove active classes from all tabs
                    tabButtons.forEach(btn => {
                        btn.classList.remove('border-indigo-500', 'text-indigo-600');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // Add active classes to clicked tab
                    button.classList.remove('border-transparent', 'text-gray-500');
                    button.classList.add('border-indigo-500', 'text-indigo-600');
                    
                    // Hide all content panels
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target content panel
                    document.getElementById(`qa-content-${targetTab}`).classList.remove('hidden');
                });
            });
        }
        
        function setupCopyButton() {
            const copyBtn = document.getElementById('copy-markdown-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    const markdownContent = document.getElementById('qa-markdown-content');
                    if (markdownContent) {
                        markdownContent.select();
                        navigator.clipboard.writeText(markdownContent.value).then(() => {
                            showToast('Markdown copiado para a √°rea de transfer√™ncia!', 'success');
                            copyBtn.textContent = '‚úÖ Copiado';
                            setTimeout(() => {
                                copyBtn.textContent = 'üìã Copiar';
                            }, 2000);
                        }).catch(() => {
                            showToast('Erro ao copiar markdown', 'error');
                        });
                    }
                });
            }
        }
        
        function setupEmbeddingsButton() {
            const embeddingsBtn = document.getElementById('create-embeddings-btn');
            if (embeddingsBtn) {
                embeddingsBtn.addEventListener('click', async () => {
                    if (!window.currentQAContent) {
                        showToast('Nenhum Q&A dispon√≠vel para criar embeddings', 'warning');
                        return;
                    }
                    
                    const collectionSelect = document.getElementById('editor-collection-select');
                    if (!collectionSelect.value) {
                        showToast('Selecione uma collection primeiro', 'warning');
                        return;
                    }
                    
                    // Mostrar modal para criar embeddings
                    showEmbeddingsModal();
                });
            }
        }
        
        function showEmbeddingsModal() {
            // Criar modal din√¢mico
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">üîó Criar Embeddings dos Q&As</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Nova Collection:</label>
                                <input type="text" id="embeddings-collection-name" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="qa_collection_embeddings">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Modelo de Embedding:</label>
                                <select id="embeddings-model-select" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    <option value="text-embedding-3-small">OpenAI text-embedding-3-small</option>
                                    <option value="text-embedding-3-large">OpenAI text-embedding-3-large</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button id="cancel-embeddings" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                                Cancelar
                            </button>
                            <button id="create-embeddings" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                                Criar Embeddings
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event handlers para o modal
            document.getElementById('cancel-embeddings').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            document.getElementById('create-embeddings').addEventListener('click', () => {
                createEmbeddingsFromQA();
                document.body.removeChild(modal);
            });
            
            // Fechar modal clicando fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        async function createEmbeddingsFromQA() {
            const collectionName = document.getElementById('embeddings-collection-name').value || 'qa_collection_embeddings';
            const embeddingModel = document.getElementById('embeddings-model-select').value;
            
            if (!window.currentQAContent) {
                showToast('Nenhum Q&A dispon√≠vel', 'error');
                return;
            }
            
            try {
                showToast('Criando embeddings dos Q&As...', 'info');
                
                // Preparar dados para o endpoint
                const qaData = {
                    qa_content: window.currentQAContent,
                    collection_name: collectionName,
                    embedding_model: embeddingModel
                };
                
                // Chamar endpoint para criar embeddings (ser√° implementado no backend)
                const response = await fetch('/api/create-qa-embeddings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(qaData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`‚úÖ Embeddings criados com sucesso na collection "${collectionName}"`, 'success');
                    // Recarregar collections para mostrar a nova
                    await loadCollections();
                } else {
                    throw new Error(result.error || 'Erro ao criar embeddings');
                }
                
            } catch (error) {
                showToast(`‚ùå Erro ao criar embeddings: ${error.message}`, 'error');
                console.error('Erro ao criar embeddings:', error);
            }
        }
        
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const result = await response.json();
                
                const sessionsList = document.getElementById('sessions-list');
                sessionsList.innerHTML = '';
                
                result.sessions.forEach(session => {
                    const sessionDiv = document.createElement('div');
                    sessionDiv.className = 'border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50';
                    sessionDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-medium text-gray-900">Sess√£o ${session.session_id.substring(0, 8)}...</h4>
                                <p class="text-sm text-gray-600">${session.message_count} mensagens</p>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                        </div>
                    `;
                    sessionDiv.onclick = () => {
                        currentSessionId = session.session_id;
                        currentSessionSpan.textContent = `Sess√£o: ${session.session_id.substring(0, 8)}...`;
                        // TODO: Load session messages
                    };
                    sessionsList.appendChild(sessionDiv);
                });
                
                // Reinitialize icons
                lucide.createIcons();
            } catch (error) {
                console.error('Erro ao carregar sess√µes:', error);
            }
        }
        
        // Document Management
        
        async function loadDocuments() {
            console.log('üîç Carregando todos os documentos...');
            try {
                const response = await fetch('/api/storage-info');
                console.log('üì° Response documentos:', response.status);
                const result = await response.json();
                console.log('üìÅ Dados documentos:', result);
                
                if (result.success && result.documents) {
                    documents = result.documents;
                    console.log('‚úÖ Documentos carregados:', documents.length);
                    console.log('üóÑÔ∏è Tipo de storage:', result.storage_type);
                    // N√£o atualizar automaticamente - esperar sele√ß√£o de collection
                } else {
                    console.error('‚ùå Falha ao carregar documentos:', result);
                    documents = [];
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar documentos:', error);
                documents = [];
            }
        }
        
        async function loadDocumentsForCollection(collectionName) {
            console.log('üîç Carregando documentos para collection:', collectionName);
            
            if (!documents || documents.length === 0) {
                console.log('‚ö†Ô∏è Nenhum documento carregado ainda - tentando recarregar...');
                await loadDocuments();
                
                if (!documents || documents.length === 0) {
                    console.log('‚ùå Ainda n√£o h√° documentos ap√≥s reload');
                    updateDocumentSelect([]);
                    return;
                }
            }
            
            console.log('üì¶ Total de documentos dispon√≠veis:', documents.length);
            console.log('üì¶ Primeiros 5 documentos completos:', documents.slice(0, 5));
            
            // Mostrar estrutura de alguns documentos para entender o formato
            documents.slice(0, 5).forEach((doc, i) => {
                console.log(`üìÑ Documento ${i + 1}:`, doc);
                console.log(`   name: ${doc.name}`);
                console.log(`   path: ${doc.path}`);
                console.log(`   object_name: ${doc.object_name}`);
            });
            
            // Filtrar documentos da collection espec√≠fica - match inteligente
            console.log('üîç Procurando por collection:', collectionName);
            
            const collectionDocuments = documents.filter(doc => {
                const docPath = doc.name || doc.path || doc;
                
                // Verificar m√∫ltiplas formas de match (case-insensitive e fuzzy)
                const collectionLower = collectionName.toLowerCase().replace('_', '');
                const pathLower = docPath.toLowerCase();
                
                const matchPatterns = [
                    // Match exato
                    pathLower.includes(collectionName.toLowerCase() + '/'),
                    // Match com case diferentes
                    pathLower.includes(collectionLower + '/'),
                    // Match sem underscores (teste_openai -> testeopenai)
                    pathLower.includes(collectionLower.replace('_', '') + '/'),
                    // Match com sufixos (_real, etc)
                    pathLower.includes(collectionLower + '_real/'),
                    pathLower.includes(collectionLower + '_test/'),
                    // Match come√ßando com o nome
                    pathLower.startsWith(collectionLower + '/'),
                    pathLower.startsWith(collectionLower.replace('_', '') + '/'),
                    // Match contendo o nome base
                    pathLower.includes('/' + collectionLower + '/'),
                    pathLower.includes(collectionLower),
                    // Match espec√≠ficos que vemos nos dados
                    (collectionName === 'teste_openai' && (pathLower.includes('testeopenai/') || pathLower.includes('teste_openai_real/'))),
                    (collectionName === 'Teste_gemini' && pathLower.includes('teste_gemini/'))
                ];
                
                const matches = matchPatterns.some(pattern => pattern);
                
                if (matches) {
                    console.log('‚úÖ MATCH encontrado!', docPath);
                }
                
                return matches;
            });
            
            console.log('üìÅ Documentos da collection encontrados:', collectionDocuments.length);
            console.log('üìÅ Paths da collection:', collectionDocuments.map(d => d.name || d.path || d));
            
            // Filtrar documentos originais de forma mais flex√≠vel
            const originalDocuments = collectionDocuments.filter(doc => {
                const docPath = doc.name || doc.path || doc;
                
                // Verificar se N√ÉO √© convertido
                const isNotConverted = !docPath.includes('/converted/') && !docPath.endsWith('.md');
                
                // Verificar extens√µes v√°lidas
                const validExtensions = ['.pdf', '.docx', '.doc', '.txt', '.pptx', '.xlsx'];
                const hasValidExtension = validExtensions.some(ext => docPath.toLowerCase().endsWith(ext));
                
                console.log('üìÑ Analisando:', docPath);
                console.log('  - N√£o convertido:', isNotConverted);
                console.log('  - Extens√£o v√°lida:', hasValidExtension);
                
                return isNotConverted && hasValidExtension;
            });
            
            console.log('üìÑ Documentos originais filtrados:', originalDocuments.length);
            console.log('üìÑ Documentos originais finais:', originalDocuments.map(d => d.name || d.path || d));
            
            // Se n√£o encontrou nenhum original, mostrar todos da collection para debug
            if (originalDocuments.length === 0 && collectionDocuments.length > 0) {
                console.log('‚ö†Ô∏è Nenhum original encontrado, mostrando todos da collection para debug');
                updateDocumentSelect(collectionDocuments);
            } else {
                updateDocumentSelect(originalDocuments);
            }
        }
        
        function updateDocumentSelect(documentsToShow = null) {
            console.log('üîÑ Atualizando select de documentos...');
            
            const docsToUse = documentsToShow || [];
            console.log('üìÅ Documentos a mostrar:', docsToUse.length);
            console.log('üìÅ Lista de documentos:', docsToUse.map(d => d.name || d.path || d));
            
            const documentSelect = document.getElementById('editor-document-select');
            if (!documentSelect) {
                console.error('‚ùå Elemento select n√£o encontrado!');
                return;
            }
            
            // Limpar op√ß√µes existentes
            documentSelect.innerHTML = '<option value="">Selecione um documento...</option>';
            
            if (docsToUse && docsToUse.length > 0) {
                docsToUse.forEach((doc, index) => {
                    const docPath = doc.name || doc.path || doc;
                    const option = document.createElement('option');
                    option.value = docPath;
                    
                    // Extrair nome mais amig√°vel do path
                    const fileName = docPath.split('/').pop();
                    
                    // Mostrar tipo de arquivo e tamanho se dispon√≠vel
                    let displayName = fileName;
                    if (doc.size) {
                        const sizeKB = Math.round(doc.size / 1024);
                        displayName += ` (${sizeKB} KB)`;
                    }
                    
                    option.textContent = displayName;
                    option.title = docPath; // Tooltip com path completo
                    
                    documentSelect.appendChild(option);
                    
                    console.log(`üìÑ ${index + 1}. Adicionado: ${fileName} (${docPath})`);
                });
                
                console.log('‚úÖ Select atualizado com', docsToUse.length, 'documentos');
            } else {
                // Mostrar mensagem informativa
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum documento encontrado para esta collection';
                option.disabled = true;
                option.style.color = '#6B7280';
                documentSelect.appendChild(option);
                
                console.log('‚ö†Ô∏è Nenhum documento encontrado - adicionada mensagem informativa');
            }
            
            // Disparar evento change para atualizar interface
            documentSelect.dispatchEvent(new Event('change'));
        }
        
        // Collection Management
        
        async function loadCollections() {
            console.log('üîç Carregando collections...');
            try {
                const response = await fetch('/api/collections');
                console.log('üì° Response collections:', response.status);
                const result = await response.json();
                console.log('üìÅ Dados collections:', result);
                
                if (result.success && result.collections) {
                    collections = result.collections;
                    console.log('‚úÖ Collections carregadas:', collections.length);
                    updateCollectionSelect();
                    updateCollectionsList();
                    updateModelFilter();
                } else {
                    console.error('‚ùå Falha ao carregar collections:', result);
                    collections = [];
                    updateCollectionSelect();
                    updateCollectionsList();
                    updateModelFilter();
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar collections:', error);
                collections = [];
                updateCollectionSelect();
                updateCollectionsList();
            }
        }
        
        async function loadEmbeddingModels() {
            try {
                const response = await fetch('/api/embedding-models');
                const result = await response.json();
                
                if (result.success) {
                    embeddingModels = result.models;
                    updateEmbeddingModelSelect();
                }
            } catch (error) {
                console.error('Erro ao carregar modelos de embedding:', error);
            }
        }
        
        function updateCollectionSelect() {
            console.log('üîÑ Atualizando selects de collection...');
            console.log('üìÅ Collections dispon√≠veis:', collections);
            
            const selects = [
                document.getElementById('upload-collection-select'),
                document.getElementById('editor-collection-select'),
                document.getElementById('chat-collection-select')
            ];
            
            selects.forEach(select => {
                if (select) {
                    console.log(`üîß Atualizando collection select: ${select.id}`);
                    select.innerHTML = '<option value="">Selecione uma collection...</option>';
                    
                    if (collections && collections.length > 0) {
                        collections.forEach(collection => {
                            const option = document.createElement('option');
                            option.value = collection.name;
                            option.textContent = `${collection.name} (${collection.embedding_model})`;
                            select.appendChild(option);
                            console.log(`  ‚ûï Collection adicionada: ${collection.name}`);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Nenhuma collection dispon√≠vel';
                        option.disabled = true;
                        select.appendChild(option);
                        console.log('‚ùå Nenhuma collection encontrada');
                    }
                }
            });
        }
        

        
        async function toggleDocuments(collectionName) {
            const documentsContainer = document.getElementById(`documents-${collectionName}`);
            const toggleButton = documentsContainer.parentElement.querySelector('button[onclick*="toggleDocuments"]');
            const toggleText = toggleButton.querySelector('.toggle-text');
            const isVisible = !documentsContainer.classList.contains('hidden');
            
            if (isVisible) {
                // Esconder documentos
                documentsContainer.classList.add('hidden');
                toggleText.textContent = 'Ver documentos';
                return;
            }
            
            // Mostrar documentos
            documentsContainer.classList.remove('hidden');
            toggleText.textContent = 'Ocultar documentos';
            
            try {
                const response = await fetch(`/api/collections/${collectionName}/documents`);
                const result = await response.json();
                
                if (result.success) {
                    if (result.documents.length === 0) {
                        documentsContainer.innerHTML = `
                            <div class="text-center py-4">
                                <i data-lucide="file-x" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                <p class="text-sm text-gray-600">Nenhum documento encontrado nesta collection</p>
                                <p class="text-xs text-gray-500 mt-1">Fa√ßa upload de um documento para come√ßar</p>
                            </div>
                        `;
                    } else {
                        let documentsHtml = `
                            <div class="mb-3">
                                <h5 class="text-sm font-medium text-gray-700 mb-2">Documentos (${result.documents.length})</h5>
                            </div>
                            <div class="space-y-2 max-h-64 overflow-y-auto">
                        `;
                        
                        result.documents.forEach(doc => {
                            console.log('üîç Processando documento:', doc);
                            const filename = doc.file_name || doc.metadata?.file_name || doc.source || 'Documento sem nome';
                            const uploadDate = doc.created_at ? new Date(doc.created_at).toLocaleString('pt-BR') : 'Data desconhecida';
                            const source = doc.metadata?.source || doc.source || 'unknown';
                            const content = doc.content || '';
                            
                            console.log('üìÑ Filename:', filename);
                            console.log('üìÖ Upload date:', uploadDate);
                            console.log('üè∑Ô∏è Source:', source);
                            
                            // Determinar √≠cone baseado no tipo de arquivo
                            let fileIcon = 'file-text';
                            if (filename.toLowerCase().endsWith('.pdf')) fileIcon = 'file-text';
                            else if (filename.toLowerCase().endsWith('.docx')) fileIcon = 'file-text';
                            else if (filename.toLowerCase().endsWith('.txt')) fileIcon = 'file-text';
                            else if (filename.toLowerCase().endsWith('.md')) fileIcon = 'file-text';
                            
                            documentsHtml += `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center space-x-2">
                                            <i data-lucide="${fileIcon}" class="w-4 h-4 text-blue-500 flex-shrink-0"></i>
                                            <span class="text-sm font-medium text-gray-900 truncate">${filename}</span>
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${source}</span>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Processado em: ${uploadDate}</p>
                                        <p class="text-xs text-gray-600 mt-1 truncate">${content.substring(0, 100)}${content.length > 100 ? '...' : ''}</p>
                                    </div>
                                </div>
                            `;
                        });
                        
                        documentsHtml += '</div>';
                        documentsContainer.innerHTML = documentsHtml;
                    }
                } else {
                    documentsContainer.innerHTML = `
                        <div class="text-center py-4">
                            <i data-lucide="alert-circle" class="w-8 h-8 text-red-400 mx-auto mb-2"></i>
                            <p class="text-sm text-red-600">Erro ao carregar documentos: ${result.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                documentsContainer.innerHTML = `
                    <div class="text-center py-4">
                        <i data-lucide="alert-circle" class="w-8 h-8 text-red-400 mx-auto mb-2"></i>
                        <p class="text-sm text-red-600">Erro ao carregar documentos: ${error.message}</p>
                    </div>
                `;
            }
            
            // Reinitialize icons
            lucide.createIcons();
        }
        
        function updateCollectionsList() {
            const container = document.getElementById('collections-list');
            container.innerHTML = '';
            
            collections.forEach(collection => {
                
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-4';
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <h4 class="font-medium text-gray-900">${collection.name}</h4>
                                <button onclick="toggleDocuments('${collection.name}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm flex items-center space-x-1 transition-colors">
                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                    <span class="toggle-text">Ver documentos</span>
                                </button>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${collection.description || 'Sem descri√ß√£o'}</p>
                            <div class="text-xs text-gray-500 mt-2">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${collection.embedding_model}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded ml-2">${collection.document_count || 0} docs</span>
                            </div>
                        </div>
                        <button onclick="deleteCollection('${collection.name}')" class="text-red-600 hover:text-red-800 text-sm">
                            Deletar
                        </button>
                    </div>
                    <div id="documents-${collection.name}" class="hidden mt-4 border-t pt-4">
                        <div class="flex items-center justify-center py-4">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                            <span class="ml-2 text-sm text-gray-600">Carregando documentos...</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            // Reinitialize icons
            lucide.createIcons();
        }
        

        
        function updateEmbeddingModelSelect() {
            const selects = [
                document.getElementById('embedding-model-select'),
                document.getElementById('collection-embedding-model-select')
            ];
            
            selects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Selecione um modelo...</option>';
                    
                    embeddingModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = `${model.name} (${model.dimension}d)`;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        function updateModelFilter() {
            const modelFilter = document.getElementById('model-filter');
            if (modelFilter) {
                modelFilter.innerHTML = '<option value="">Todos os modelos</option>';
                
                // Obter modelos √∫nicos das collections
                const uniqueModels = [...new Set(collections.map(c => c.embedding_model))];
                
                uniqueModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelFilter.appendChild(option);
                });
            }
        }
        
        // Modal functions
        function showCollectionModal() {
            document.getElementById('collection-modal').classList.remove('hidden');
        }
        
        function hideCollectionModal() {
            document.getElementById('collection-modal').classList.add('hidden');
            document.getElementById('collection-name-input').value = '';
            document.getElementById('collection-description-input').value = '';
            document.getElementById('collection-embedding-model-select').value = '';
            document.getElementById('collection-model-info').classList.add('hidden');
        }
        

        
        async function createCollection() {
            const name = document.getElementById('collection-name-input').value.trim();
            const description = document.getElementById('collection-description-input').value.trim();
            const embeddingModel = document.getElementById('collection-embedding-model-select').value;
            
            if (!name || !embeddingModel) {
                showToast('Nome da collection e modelo de embedding s√£o obrigat√≥rios', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/collections', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        embedding_model: embeddingModel
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    hideCollectionModal();
                    await loadCollections();
                    showToast('Collection criada com sucesso!', 'success');
                } else {
                    showToast(`Erro ao criar collection: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`Erro ao criar collection: ${error.message}`, 'error');
            }
        }
        
        async function deleteCollection(collectionName) {
            if (!confirm(`Tem certeza que deseja deletar a collection "${collectionName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/collections/${collectionName}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadCollections();
                    showToast('Collection deletada com sucesso!', 'success');
                } else {
                    showToast(`Erro ao deletar collection: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`Erro ao deletar collection: ${error.message}`, 'error');
            }
        }
        
        function filterCollectionsByModel(selectedModel) {
            const container = document.getElementById('collections-list');
            const collectionElements = container.querySelectorAll('.border');
            
            collectionElements.forEach(element => {
                const collectionName = element.querySelector('h4').textContent;
                const collection = collections.find(c => c.name === collectionName);
                
                if (selectedModel === '' || collection.embedding_model === selectedModel) {
                    element.style.display = 'block';
                } else {
                    element.style.display = 'none';
                }
            });
        }
        

        
        const newCollectionBtn = document.getElementById('new-collection-btn');
        if (newCollectionBtn) newCollectionBtn.addEventListener('click', showCollectionModal);
        
        const cancelCollectionBtn = document.getElementById('cancel-collection-btn');
        if (cancelCollectionBtn) cancelCollectionBtn.addEventListener('click', hideCollectionModal);
        
        const createCollectionBtn = document.getElementById('create-collection-btn');
        if (createCollectionBtn) createCollectionBtn.addEventListener('click', createCollection);
        
        // Filtro por modelo
        const modelFilter = document.getElementById('model-filter');
        if (modelFilter) {
            modelFilter.addEventListener('change', (e) => {
                const selectedModel = e.target.value;
                filterCollectionsByModel(selectedModel);
            });
        }
        
        const embeddingModelSelect = document.getElementById('embedding-model-select');
        if (embeddingModelSelect) {
            embeddingModelSelect.addEventListener('change', (e) => {
                const modelId = e.target.value;
                const model = embeddingModels.find(m => m.id === modelId);
                
                const modelInfo = document.getElementById('model-info');
                if (model) {
                    const modelName = document.getElementById('model-name');
                    const modelDimension = document.getElementById('model-dimension');
                    const modelProvider = document.getElementById('model-provider');
                    
                    if (modelName) modelName.textContent = model.name;
                    if (modelDimension) modelDimension.textContent = model.dimension;
                    if (modelProvider) modelProvider.textContent = model.provider;
                    if (modelInfo) modelInfo.classList.remove('hidden');
                } else {
                    if (modelInfo) modelInfo.classList.add('hidden');
                }
            });
        }
        

        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM carregado! Iniciando aplica√ß√£o...');
            
            try {
                console.log('üìÅ Chamando initializeUpload...');
                initializeUpload();
                console.log('‚úÖ initializeUpload conclu√≠do');
            } catch (error) {
                console.error('‚ùå Erro em initializeUpload:', error);
            }
            

            

            
            try {
                console.log('üìÅ Chamando loadCollections...');
                loadCollections();
                console.log('‚úÖ loadCollections chamado');
            } catch (error) {
                console.error('‚ùå Erro em loadCollections:', error);
            }
            
            try {
                console.log('üìÅ Chamando loadDocuments...');
                loadDocuments();
                console.log('‚úÖ loadDocuments chamado');
            } catch (error) {
                console.error('‚ùå Erro em loadDocuments:', error);
            }
            
            // Outros m√©todos simplificados
            try {
                loadSessions();
                loadEmbeddingModels();
            } catch (error) {
                console.error('‚ùå Erro em outras fun√ß√µes:', error);
            }
        });
        
        // Inicializar √≠cones Lucide (removed due to CSP)
        // lucide.createIcons();
    </script>
</body>
</html> 